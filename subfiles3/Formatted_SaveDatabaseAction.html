<html xmlns="http://www.w3.org/1999/xhtml">
  <body>
  <line><comment type="block" format="javadoc">/**<br/>
* Run the "Save as" operation. This method offloads the actual save operation to a background thread, but<br/>
* still runs synchronously using Spin (the method returns only after completing the operation).<br/>
*/</comment></line><br/>
<line class="method-sig">1 <function><specifier>public</specifier> <type><name>void</name></type> <name>saveAs</name><parameter_list>()</parameter_list> <throws>throws <argument><expr><name>Throwable</name></expr></argument></throws> <block>{</line><br/>
<line>2  &nbsp;&nbsp;&nbsp;&nbsp;<decl_stmt><decl><type><name>String</name></type> <name>chosenFile</name> <init>= <expr><literal type="null">null</literal></expr></init></decl>;</decl_stmt></line><br/>
<line>3  &nbsp;&nbsp;&nbsp;&nbsp;<decl_stmt><decl><type><name>File</name></type> <name>f</name> <init>= <expr><literal type="null">null</literal></expr></init></decl>;</decl_stmt></line><br/>
<line>4  &nbsp;&nbsp;&nbsp;&nbsp;<while>while <condition>(<expr><name>f</name> <operator>==</operator> <literal type="null">null</literal></expr>)</condition> <block>{</line><br/>
<line>5  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<expr_stmt><expr><name>chosenFile</name> <operator>=</operator> <call><name><name>FileDialogs</name><operator>.</operator><name>getNewFile</name></name><argument_list>(<argument><expr><name>frame</name></expr></argument>, <argument><expr><operator>new</operator> <call><name>File</name><argument_list>(<argument><expr><call><name><name>Globals</name><operator>.</operator><name>prefs</name><operator>.</operator><name>get</name></name><argument_list>(<argument><expr><name><name>JabRefPreferences</name><operator>.</operator><name>WORKING_DIRECTORY</name></name></expr></argument>)</argument_list></call></expr></argument>)</argument_list></call></expr></argument>, <argument><expr><literal type="string">".bib"</literal></expr></argument>,<br/>
&nbsp;   &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<argument><expr><name><name>JFileChooser</name><operator>.</operator><name>SAVE_DIALOG</name></name></expr></argument>, <argument><expr><literal type="boolean">false</literal></expr></argument>, <argument><expr><literal type="null">null</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt></line><br/>
<line>6  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<if>if <condition>(<expr><name>chosenFile</name> <operator>==</operator> <literal type="null">null</literal></expr>)</condition><then> <block>{</line><br/>
<line>7  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<expr_stmt><expr><name>cancelled</name> <operator>=</operator> <literal type="boolean">true</literal></expr>;</expr_stmt></line><br/>
<line>8  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<return>return;</return> <comment type="line">// cancelled</comment></line><br/>
<line>9  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</block></then></if></line><br/>
<line>10 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<expr_stmt><expr><name>f</name> <operator>=</operator> <operator>new</operator> <call><name>File</name><argument_list>(<argument><expr><name>chosenFile</name></expr></argument>)</argument_list></call></expr>;</expr_stmt></line><br/>
<line>11 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<comment type="line">// Check if the file already exists:</comment></line><br/>
<line>12 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<if>if <condition>(<expr><call><name><name>f</name><operator>.</operator><name>exists</name></name><argument_list>()</argument_list></call> <operator>&amp;&amp;</operator> <operator>(</operator><call><name><name>JOptionPane</name><operator>.</operator><name>showConfirmDialog</name></name><argument_list>(<argument><expr><name>frame</name></expr></argument>,<br/>
&nbsp;   &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<argument><expr><call><name><name>Localization</name><operator>.</operator><name>lang</name></name><argument_list>(<argument><expr><literal type="string">"'%0' exists. Overwrite file?"</literal></expr></argument>, <argument><expr><call><name><name>f</name><operator>.</operator><name>getName</name></name><argument_list>()</argument_list></call></expr></argument>)</argument_list></call></expr></argument>,<br/>
&nbsp;   &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<argument><expr><call><name><name>Localization</name><operator>.</operator><name>lang</name></name><argument_list>(<argument><expr><literal type="string">"Save database"</literal></expr></argument>)</argument_list></call></expr></argument>, <argument><expr><name><name>JOptionPane</name><operator>.</operator><name>OK_CANCEL_OPTION</name></name></expr></argument>)</argument_list></call> <operator>!=</operator> <name><name>JOptionPane</name><operator>.</operator><name>OK_OPTION</name></name><operator>)</operator></expr>)</condition><then> <block>{</line><br/>
<line>13 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<expr_stmt><expr><name>f</name> <operator>=</operator> <literal type="null">null</literal></expr>;</expr_stmt></line><br/>
<line>14 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</block></then></if></line><br/>
<line>15 &nbsp;&nbsp;&nbsp;&nbsp;}</block></while></line><br/>
<line>16 &nbsp;&nbsp;&nbsp;&nbsp;<if>if <condition>(<expr><name>chosenFile</name> <operator>!=</operator> <literal type="null">null</literal></expr>)</condition><then> <block>{</line><br/>
<line>17 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<decl_stmt><decl><type><name>File</name></type> <name>oldFile</name> <init>= <expr><call><name><name>panel</name><operator>.</operator><name>metaData</name></name><argument_list>()</argument_list></call><operator>.</operator><call><name>getFile</name><argument_list>()</argument_list></call></expr></init></decl>;</decl_stmt></line><br/>
<line>18 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<expr_stmt><expr><call><name><name>panel</name><operator>.</operator><name>metaData</name></name><argument_list>()</argument_list></call><operator>.</operator><call><name>setFile</name><argument_list>(<argument><expr><name>f</name></expr></argument>)</argument_list></call></expr>;</expr_stmt></line><br/>
<line>19 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<expr_stmt><expr><call><name><name>Globals</name><operator>.</operator><name>prefs</name><operator>.</operator><name>put</name></name><argument_list>(<argument><expr><name><name>JabRefPreferences</name><operator>.</operator><name>WORKING_DIRECTORY</name></name></expr></argument>, <argument><expr><call><name><name>f</name><operator>.</operator><name>getParent</name></name><argument_list>()</argument_list></call></expr></argument>)</argument_list></call></expr>;</expr_stmt></line><br/>
<line>20 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<expr_stmt><expr><call><name>runCommand</name><argument_list>()</argument_list></call></expr>;</expr_stmt></line><br/>
<line>21 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<comment type="line">// If the operation failed, revert the file field and return:</comment></line><br/>
<line>22 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<if>if <condition>(<expr><operator>!</operator><name>success</name></expr>)</condition><then> <block>{</line><br/>
<line>23 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<expr_stmt><expr><call><name><name>panel</name><operator>.</operator><name>metaData</name></name><argument_list>()</argument_list></call><operator>.</operator><call><name>setFile</name><argument_list>(<argument><expr><name>oldFile</name></expr></argument>)</argument_list></call></expr>;</expr_stmt></line><br/>
<line>24 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<return>return;</return></line><br/>
<line>25 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</block></then></if></line><br/>
<line>26 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<comment type="line">// Register so we get notifications about outside changes to the file.</comment></line><br/>
<line>27 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<try>try <block>{</line><br/>
<line>28 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<expr_stmt><expr><call><name><name>panel</name><operator>.</operator><name>setFileMonitorHandle</name></name><argument_list>(<argument><expr><call><name><name>Globals</name><operator>.</operator><name>fileUpdateMonitor</name><operator>.</operator><name>addUpdateListener</name></name><argument_list>(<argument><expr><name>panel</name></expr></argument>, <argument><expr><call><name><name>panel</name><operator>.</operator><name>getDatabaseFile</name></name><argument_list>()</argument_list></call></expr></argument>)</argument_list></call></expr></argument>)</argument_list></call></expr>;</expr_stmt></line><br/>
<line>29 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</block> <catch>catch <parameter_list>(<parameter><decl><type><name>IOException</name></type> <name>ex</name></decl></parameter>)</parameter_list> <block>{</line><br/>
<line>30 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<expr_stmt><expr><call><name><name>ex</name><operator>.</operator><name>printStackTrace</name></name><argument_list>()</argument_list></call></expr>;</expr_stmt></line><br/>
<line>31 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</block></catch></try></line><br/>
<line>32 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<expr_stmt><expr><call><name><name>frame</name><operator>.</operator><name>getFileHistory</name></name><argument_list>()</argument_list></call><operator>.</operator><call><name>newFile</name><argument_list>(<argument><expr><call><name><name>panel</name><operator>.</operator><name>metaData</name></name><argument_list>()</argument_list></call><operator>.</operator><call><name>getFile</name><argument_list>()</argument_list></call><operator>.</operator><call><name>getPath</name><argument_list>()</argument_list></call></expr></argument>)</argument_list></call></expr>;</expr_stmt></line><br/>
<line>33 &nbsp;&nbsp;&nbsp;&nbsp;}</block></then></if></line><br/>
<line>34</line><br/>
<line>35}</block></function></line><br/>
</body></html>
